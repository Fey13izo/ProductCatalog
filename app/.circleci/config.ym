yml
version: 2.1 # It's good practice to use version 2.1 for access to modern features

jobs:
  build:
    # Use a modern Android image from CircleCI's "cimg" set
    docker:
      - image: cimg/android:2023.09

    # Set the working directory for all subsequent steps
    working_directory: ~/project

    steps:
      # Step 1: Get the code from your repository
      - checkout

      # Step 2: Restore Gradle cache to speed up builds
      # This checks for previously saved dependencies.
      - restore_cache:
          key: gradle-wrapper-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}

      - restore_cache:
          key: gradle-cache-{{ checksum "build.gradle" }}-{{ checksum "app/build.gradle" }}

      # Step 3: THIS IS THE FIX. Switch to the correct Java version.
      # The cimg/android images have JDK 17 pre-installed.
      - run:
          name: Set Java 17 as default
          command: |
            sudo update-java-alternatives --set /usr/lib/jvm/java-1.17.0-openjdk-amd64
            echo 'export JAVA_HOME=/usr/lib/jvm/java-1.17.0-openjdk-amd64' >> $BASH_ENV
            source $BASH_ENV
            java -version # Verify that Java 17 is now active

      # Step 4: Grant execute permissions to the Gradle wrapper
      - run:
          name: Grant Permissions
          command: chmod +x ./gradlew

      # Step 5: Download dependencies. This will run faster if the cache was restored.
      - run:
          name: Download Dependencies
          command: ./gradlew androidDependencies --no-daemon

      # Step 6: Save the downloaded dependencies to the cache for future builds
      - save_cache:
          key: gradle-wrapper-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
          paths:
            - ~/.gradle/wrapper
      - save_cache:
          key: gradle-cache-{{ checksum "build.gradle" }}-{{ checksum "app/build.gradle" }}
          paths:
            - ~/.gradle/caches

      # Step 7: Build the debug APK
      - run:
          name: Build App
          command: ./gradlew assembleDebug --no-daemon --stacktrace

      # Step 8: Run unit tests
      - run:
          name: Run Unit Tests
          command: ./gradlew testDebugUnitTest --no-daemon --stacktrace

      # Optional: Store build artifacts (like the APK) so you can download them
      - store_artifacts:
          path: app/build/outputs/apk/debug
          destination: apks

      # Optional: Store test results for better insights in the CircleCI UI
      - store_test_results:
          path: app/build/test-results

workflows:
  build_and_test:
    jobs:
      - build

