  yml
  version: 2.1

  jobs:
    build:
      # Use a modern Android image that is known to have JDK 17
      docker:
        - image: cimg/android:2023.09

      working_directory: ~/project

      steps:
        - checkout

        # Restore caches for faster builds
        - restore_cache:
            keys:
              - gradle-wrapper-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
              - gradle-cache-{{ checksum "build.gradle" }}-{{ checksum "app/build.gradle" }}

        # Grant execute permissions to the Gradle wrapper
        - run:
            name: Grant Permissions
            command: chmod +x ./gradlew

        # --- THIS IS THE NEW, MORE FORCEFUL APPROACH ---
        # Define the correct JAVA_HOME once as an environment variable for subsequent steps.
        - run:
            name: Set and Verify JAVA_HOME
            command: |
              echo 'export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64' >> $BASH_ENV
              source $BASH_ENV
              echo "JAVA_HOME is now set to: $JAVA_HOME"
              java -version

        # Run Gradle commands. They will now automatically pick up the JAVA_HOME set in the previous step.
        - run:
            name: Download Dependencies
            command: ./gradlew androidDependencies --no-daemon --stacktrace

        - run:
            name: Build App
            command: ./gradlew assembleDebug --no-daemon --stacktrace

        - run:
            name: Run Unit Tests
            command: ./gradlew testDebugUnitTest --no-daemon --stacktrace

        # Save caches for future builds
        - save_cache:
            key: gradle-wrapper-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
            paths:
              - ~/.gradle/wrapper
        - save_cache:
            key: gradle-cache-{{ checksum "build.gradle" }}-{{ checksum "app/build.gradle" }}
            paths:
              - ~/.gradle/caches

        # Store artifacts and test results
        - store_artifacts:
            path: app/build/outputs/apk/debug
            destination: apks
        - store_test_results:
            path: app/build/test-results

  workflows:
    build_and_test:
      jobs:
        - build
